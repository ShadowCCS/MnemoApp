<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Mnemo.UI.Modules.Path.ViewModels"
             xmlns:models="using:Mnemo.Core.Models"
             xmlns:controls="using:Mnemo.UI.Controls"
             xmlns:converters="using:Mnemo.UI.Converters"
             xmlns:components="using:Mnemo.UI.Components"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="800"
             x:Class="Mnemo.UI.Modules.Path.Views.PathDetailView"
             x:DataType="vm:PathDetailViewModel"
             Foreground="{DynamicResource TextSecondaryBrush}"
             x:Name="rootDetail">

    <UserControl.Resources>
        <converters:BoolToBrushConverter x:Key="BoolToBrushConverter" 
                                        TrueBrush="{DynamicResource CardAccentBrush}" 
                                        FalseBrush="{DynamicResource TextTertiaryBrush}"/>
        <converters:StatusToBoolConverter x:Key="StatusToBoolConverter"/>
        <converters:BoolNegationConverter x:Key="BoolNegationConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="controls|SvgIcon.Spinning">
            <Style.Animations>
                <Animation Duration="0:0:2" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem">
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Margin" Value="8,2"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="ClipToBounds" Value="False"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.2"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.01)"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:pressed">
            <Setter Property="RenderTransform" Value="scale(0.99)"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListBoxItemBackgroundPointerOverBrush}"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:pressed /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListBoxItemBackgroundPressedBrush}"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:selected /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListBoxItemBackgroundSelectedBrush}"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:selected TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ListBoxItemForegroundSelectedBrush}"/>
        </Style>

        <Style Selector="ListBox.UnitList ListBoxItem:pointerover TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ListBoxItemForegroundPointerOverBrush}"/>
        </Style>
    </UserControl.Styles>

    <SplitView IsPaneOpen="{Binding IsSidebarOpen}"
               DisplayMode="Inline"
               OpenPaneLength="300"
               Background="Transparent"
               PaneBackground="{DynamicResource CardBackgroundPrimaryBrush}">
        <SplitView.Pane>
            <Border BorderThickness="0,0,1,0" BorderBrush="{DynamicResource SearchBarBackgroundBrush}">
                <Grid RowDefinitions="Auto,*">
                    <StackPanel Grid.Row="0" Margin="20" Spacing="8">
                        <TextBlock Text="{Binding Path.Title}" 
                                   FontSize="{DynamicResource FontSize.Heading4}" 
                                   FontFamily="{DynamicResource Font.Bold}" 
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   TextWrapping="Wrap"/>
                        <ProgressBar Value="{Binding Path.Progress}" Height="6" CornerRadius="3"
                                     Background="{DynamicResource ProgressBarBackgroundBrush}"
                                     Foreground="{DynamicResource CardAccentBrush}"/>
                        <TextBlock Text="{Binding Path.Progress, StringFormat={}{0:0}% complete}" 
                                   FontSize="{DynamicResource FontSize.Body.ExtraSmall}" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>

                    <ListBox Grid.Row="1" ItemsSource="{Binding Units}" SelectedItem="{Binding SelectedUnit}" 
                             Background="Transparent" Cursor="Hand" Classes="UnitList">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="models:LearningUnit">
                                <StackPanel Spacing="4">
                                    <DockPanel>
                                        <Border Width="20" Height="20" CornerRadius="10" 
                                                Background="{Binding IsCompleted, Converter={StaticResource BoolToBrushConverter}}" 
                                                IsVisible="{Binding IsCompleted}" Margin="0,0,8,0">
                                            <controls:SvgIcon SvgPath="avares://Mnemo.UI/Icons/Tabler/Used/Outlined/circle.svg" Width="12" Height="12" Color="White"/>
                                        </Border>
                                        <TextBlock Text="{Binding Title}" 
                                                   FontFamily="{DynamicResource Font.SemiBold}" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center" TextWrapping="Wrap"/>
                                    </DockPanel>
                                    <TextBlock Text="{Binding Goal}" 
                                               FontSize="{DynamicResource FontSize.Caption}" 
                                               Foreground="{DynamicResource TextTertiaryBrush}" 
                                               MaxLines="2" TextTrimming="CharacterEllipsis"/>
                                    <ProgressBar IsVisible="{Binding Status, Converter={StaticResource StatusToBoolConverter}, ConverterParameter='Running'}" IsIndeterminate="True" Height="2" Margin="0,4,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>
        </SplitView.Pane>

        <Grid RowDefinitions="Auto,*">
            <Button Command="{Binding ToggleSidebarCommand}"
                    Margin="20,20,0,0"
                    Padding="8"
                    Background="Transparent"
                    BorderThickness="0"
                    VerticalAlignment="Top"
                    HorizontalAlignment="Left">
                <controls:SvgIcon SvgPath="avares://Mnemo.UI/Icons/Tabler/Used/Filled/layout-sidebar.svg" 
                                  Width="20" Height="20" 
                                  Color="{DynamicResource TextSecondaryBrush}"/>
            </Button>

            <!-- Main Content -->
            <ScrollViewer Grid.Row="1">
                <StackPanel Margin="40,0,40,40" Spacing="24">
                    <ContentControl Content="{Binding SelectedUnit}">
                        <ContentControl.ContentTemplate>
                            <DataTemplate DataType="models:LearningUnit">
                                <StackPanel Spacing="30">
                                    <StackPanel Spacing="10">
                                        <TextBlock Text="{Binding Title}" 
                                                   FontSize="{DynamicResource FontSize.Heading1}" 
                                                   FontFamily="{DynamicResource Font.Bold}"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <TextBlock Text="{Binding Goal}" 
                                                   FontSize="{DynamicResource FontSize.Body.Medium}" 
                                                   Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                    </StackPanel>

                                    <Border IsVisible="{Binding !IsCompleted}" 
                                            Padding="40" 
                                            Background="{DynamicResource CardBackgroundSecondaryBrush}" 
                                            CornerRadius="16">
                                        <StackPanel Spacing="20" HorizontalAlignment="Center">
                                            <controls:SvgIcon SvgPath="avares://Mnemo.UI/Icons/Tabler/Used/Outlined/circle.svg" 
                                                              Width="48" Height="48" Color="{DynamicResource CardAccentBrush}"
                                                              Classes="Spinning"/>
                                            <TextBlock Text="Generating content..." 
                                                       FontSize="{DynamicResource FontSize.Heading5}" 
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       HorizontalAlignment="Center"/>
                                            <Button Content="Regenerate Now" Command="{Binding #rootDetail.((vm:PathDetailViewModel)DataContext).GenerateUnitCommand}" CommandParameter="{Binding}" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Border>

                                    <components:MarkdownView Source="{Binding Content}" 
                                                             IsVisible="{Binding IsCompleted}"
                                                             Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </SplitView>
</UserControl>

